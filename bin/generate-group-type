#!/usr/bin/env node
const path = require("node:path");
const fs = require("node:fs");
const { LoggerImpl, NodeFileService } = require("@adviser/cement");

let dist = __dirname;
let distDir = path.join(dist, "../dist");
if (fs.existsSync(distDir)) {
  dist = distDir;
}
function nodeInclude(p) {
  if (path.isAbsolute(p)) {
    return p;
  }
  return `./${p}`;
}

const { generateGroupTSType } = require(nodeInclude(path.join(dist, "generate_group_tstype")));
const { generateGroupJSONSchema } = require(nodeInclude(path.join(dist, "generate_group_jsonschema")));

const { fromSystem } = require(nodeInclude(path.join(dist, "cli_parser")));

const { GenerateGroupConfigFactory } = require(nodeInclude(path.join(dist, "generated", "generategroupconfig")));

const log = new LoggerImpl();
const cfg = fromSystem(GenerateGroupConfigFactory, {
  log,
  env: process.env,
  args: process.argv.slice(2),
}).Ok();

const sfs = new NodeFileService();

(async () => {
  for (const f of cfg.input_files) {
    const gg = {
      log,
      fs: sfs,
      filter: cfg.filter,
      includePath: cfg.include_path,
      notSelected: cfg.not_selected,
      outDir: cfg.output_dir,
    };
    switch (cfg.output_format) {
      case "JSchema":
        await generateGroupJSONSchema(f, gg);
        break;
      default:
        await generateGroupTSType(f, gg);
    }
  }
})().catch((e) => console.error(e));
